<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embedded map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/map.css" rel="stylesheet">
    <link href="vendor/leaflet/leaflet.css" rel="stylesheet">
    <style>
        html,body {
            width: 100%;
            height: 100%;
        }
        section.map {
            display: flex;
            height: 100%;
            width: 100%;
            flex-wrap: wrap;
        }
        #azniirkh-map {
            height: 100%;
            flex: 1 50%;
        }
        #azniirkh-legend {
            height: 100%;
            flex: 1;
        }
        @media (max-width: 767px) {
            #azniirkh-map {
                flex: 1 100%;
                height: 70%;
            }
            #azniirkh-legend {
                flex: 0 100%;
                height: 40%;
            }
        }

    </style>
</head>
<body>

<section class="map">
    <div id="azniirkh-map"></div>
    <div id="azniirkh-legend">
        <div class="card">
            <div class="card-header mb-0">Управление</div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs nav-fill mb-2" id="menuTab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" href="#data" role="tab" id="data-tab" data-toggle="tab" aria-controls="data" aria-selected="true">Слои</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#settings" role="tab" id="settings-tab" data-toggle="tab" aria-controls="settings" aria-selected="false">Настройки</a>
                  </li>
                </ul>
                <div class="tab-content" id="menuTabContent">
                  <div class="tab-pane fade show active" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="gis-layer-list">
						<!--<div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-waters" data-toggle="multilayer" data-target="azniirkh_zones:water-bodies-all,multipoly;azniirkh_zones:waterways-all,lines">
                                    <label class="custom-control-label" for="gis-waters">Водные объекты (данные OSM)</label>
                                </div>
                            </div>
                        </div>-->
						<div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">Водные объекты</div>
                            <small class="text-muted d-none d-sm-block">Водные объекты в зоне ответственности АзНИИРХ</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="waters-rivers" data-toggle="lines" data-target="azniirkh_zones:rivers" data-color="#00cee4">
                                    <label class="custom-control-label" for="waters-rivers">Реки</label>
                                </div>

                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="waters-lakes" data-toggle="lines" data-target="azniirkh_zones:lakes_reservoirs" data-color="#00cee4">
                                    <label class="custom-control-label" for="waters-lakes">Озера и водохранилища</label>
                                </div>

                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-rostov-waters" data-toggle="multilayer" data-target="azniirkh_zones:water-bodies-rostov,multipoly;azniirkh_zones:waterways-rostov,lines" data-color="#00cee4">
                                    <label class="custom-control-label" for="gis-rostov-waters" style="color:lightgrey">Ростовская обл <sup style="color:brown">устаревш.</sup></label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-azniirkh-zone" data-toggle="multipoly" data-target="azniirkh_zones:azniirkh_zone" data-color="#e24418">
                                    <label class="custom-control-label" for="gis-azniirkh-zone">Зона ответственности АзНИИРХ</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rpu-all-zones" data-toggle="multipoly" data-target="azniirkh_zones:rpu" data-color="#e0b90d">
                                    <label class="custom-control-label" for="rpu-all-zones">Рыбопромысловые участки</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">Рыбоводные участки</div>
                            <small class="text-muted d-none d-sm-block">Границы рыбоводных участков субъектов предпринимательства</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-rostov-areas" data-toggle="multipoly" data-target="azniirkh_zones:rvu_rostovskaya_oblast" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-rostov-areas">Ростовская обл</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-krasnodar-areas" data-toggle="multiline" data-target="azniirkh_zones:rvu_krasnodarsky_kray" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-krasnodar-areas">Краснодарский край</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-stavropol-areas" data-toggle="multiline" data-target="azniirkh_zones:rvu_stavropolsky_kray" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-stavropol-areas">Ставропольский край</label>
                                </div>
                                <hr style="margin: 0;" />
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="show-all-rvu" data-toggle="checkall" data-target="rvu-rostov-areas,rvu-krasnodar-areas,rvu-stavropol-areas">
                                    <label class="custom-control-label" for="show-all-rvu">показать все слои</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">Морские режимные районы</div>
                            <small class="text-muted d-none d-sm-block">Режимные районы Азовского и Черного моря с запретами и ограничениями судоходства</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="restrict-zapret-dlya-plavaniya" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_zapretnye_dlya_plavaniya" data-color="#ff6f01">
                                    <label class="custom-control-label" for="restrict-zapret-dlya-plavaniya">Районы, запретные для плавания</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="restrict-zapret-dlya-ostanovki" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_zapretnye_dlya_ostanovki" data-color="#ff6f01">
                                    <label class="custom-control-label" for="restrict-zapret-dlya-ostanovki">Районы, запретные для остановки, постановки на якорь, лова рыбы придонными орудиями лова, подводных и дноуглубительных работ, взрывных работ и плавания с вытравленной якорь-цепью</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="restrict-zapret-vremenii-plavanie" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_vremenno_opasnye" data-color="#ff6f01">
                                    <label class="custom-control-label" for="restrict-zapret-vremenii-plavanie">Районы, временно опасные для плавания</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="restrict-nomernie-raiony" data-toggle="multipoly" data-target="azniirkh_zones:Nomernye_raiony" data-color="#ff6f01">
                                    <label class="custom-control-label" for="restrict-nomernie-raiony">Номерные районы (для учений флота)</label>
                                </div>
                                <hr style="margin: 0;" />
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="show-all-restrict" data-toggle="checkall" data-target="restrict-zapret-dlya-plavaniya,restrict-zapret-dlya-ostanovki,restrict-zapret-vremenii-plavanie,restrict-nomernie-raiony">
                                    <label class="custom-control-label" for="show-all-restrict">показать все слои</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">Районы, опасные в навигационном отношении</div>
                            <small class="text-muted d-none d-sm-block">Районы Азовского и Черного моря опасные в навигационном отношении для судоходства</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="dangerous-sledyet-izbegat" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_kotoryh_sleduet_izbegat" data-color="#ba0808">
                                    <label class="custom-control-label" for="dangerous-sledyet-izbegat">Районы, которые судам следует избегать</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="dangerous-vzryv-veschestv" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_zatopl_vzryv_veschestv" data-color="#ba0808">
                                    <label class="custom-control-label" for="dangerous-vzryv-veschestv">Районы затопленных взрывчатых веществ</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="dangerous-svalka-grunta-deistv" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_svalki_grunta_deistv" data-color="#ba0808">
                                    <label class="custom-control-label" for="dangerous-svalka-grunta-deistv">Районы свалки грунта (действующие)</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="dangerous-svalka-grunta-old" data-toggle="multipoly" data-target="azniirkh_zones:Raiony_svalki_grunta_byvshie" data-color="#ba0808">
                                    <label class="custom-control-label" for="dangerous-svalka-grunta-old">Районы свалки грунта (бывшие)</label>
                                </div>
                                <hr style="margin: 0;" />
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="show-all-dangerous" data-toggle="checkall" data-target="dangerous-sledyet-izbegat,dangerous-vzryv-veschestv,dangerous-svalka-grunta-deistv,dangerous-svalka-grunta-old">
                                    <label class="custom-control-label" for="show-all-dangerous">показать все слои</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="restrict-oldest-now-safity" data-toggle="multipoly" data-target="azniirkh_zones:Byvshie_opasnie_ot_min_raiony" data-color="#365ec4">
                                    <label class="custom-control-label" for="restrict-oldest-now-safity">Бывшие опасные от мин районы, открытые для плавания судов</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-oopt" data-toggle="multipoly" data-target="azniirkh_zones:oopt" data-color="#e21776">
                                    <label class="custom-control-label" for="gis-oopt">Особо охраняемые зоны</label>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
                  <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                  <div class="gis-settings">
                    <div class="text-head-major">Просмотр области</div>
                        <div class="ml-2">
                            <span class="badge badge-light" id="gis-zoom-azov">🔎 Азов</span>
                            <span class="badge badge-light" id="gis-zoom-blacksea">🔎 ЧМ</span>
                            <span class="badge badge-light" id="gis-zoom-rostov">🔎 Ростов</span>
                            <span class="badge badge-light" id="gis-zoom-krasnodar">🔎 Краснодар</span>
                        </div>
                  </div>
                  <div class="gis-settings">
                    <div class="text-head-major">Подложка</div>
                    <div class="ml-2">
                        <div class="custom-control custom-radio custom-control-inline">
                          <input type="radio" id="gis-tile-yandex" name="gis-tile" class="custom-control-input">
                          <label class="custom-control-label" for="gis-tile-yandex">Спутник</label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline">
                          <input type="radio" id="gis-tile-yandex-scheme" name="gis-tile" class="custom-control-input" checked>
                          <label class="custom-control-label" for="gis-tile-yandex-scheme">Схема</label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline">
                          <input type="radio" id="gis-tile-azniirkh" name="gis-tile" class="custom-control-input">
                          <label class="custom-control-label" for="gis-tile-azniirkh">АзНИИРХ</label>
                        </div>
                    </div>
                  </div>
                  <div class="gis-settings">
                    <div class="text-head-major">Местность</div>
                    <div class="ml-2">
                        <div class="custom-control custom-checkbox custom-control-inline">
                          <input type="checkbox" id="gis-cities" name="gis-cities" class="custom-control-input" data-toggle="point" data-target="azniirkh_zones:south_russia_placekeys">
                          <label class="custom-control-label" for="gis-cities">Города</label>
                        </div>
                        <div class="custom-control custom-checkbox custom-control-inline">
                          <input type="checkbox" id="gis-borders" name="gis-borders" class="custom-control-input">
                          <label class="custom-control-label" for="gis-borders">Округа</label>
                        </div>
                    </div>
                  </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal tree element -->
<div class="modal fade" id="modalTreeDisplay" tabindex="-1" role="dialog" aria-labelledby="modalTreeDisplay" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Параметры объекта: <span id="display-layer-name-span">unknown</span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="modal-search-field" placeholder="Поисковой запрос ..." aria-label="Поисковой запрос" aria-describedby="button-make-search">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" id="modal-search-btn" type="button" id="button-make-search">Найти</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-found-text" class="d-none">Найдено: <span id="modal-found-count">0</span></div>
            <div class="modal-feature"></div>
        </div>
      </div>
    </div>
  </div>

    <script src="vendor/jquery/jquery-3.3.1.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/leaflet/leaflet.js"></script>
    <script src='vendor/turf/turf.min.js'></script>
    <script src="js/gis.js"></script>

    <script>
        var enabledLayers = {};

        // define map object with center
        var map = L.map('azniirkh-map').setView([46, 36], 7);
        
        var bg = L.tileLayer(
          'https://vec{s}.maps.yandex.net/tiles?l=map&v=3.378.0&z={z}&x={x}&y={y}&lang=ru_RU', {
            subdomains: ['01', '02', '03', '04'],
            attribution: '<a href="https://yandex.ru" target="_blank">Яндекс</a> | <a href="http://azniirkh.ru">АзНИИРХ</a>',
            reuseTiles: true,
            updateWhenIdle: false
          }
        ).addTo(map);
        // change map projection. Yandex: L.CRS.EPSG3395
        map.options.crs = L.CRS.EPSG3395;

        // execute after-load features with jquery
        $(function(){
            // visual display hidden elements
            $('.gis-group-layer').on('click', function(e) {
                var clickedTargetName = $(e.target).prop('tagName');
                if(clickedTargetName == "INPUT" || clickedTargetName === "LABEL" || clickedTargetName === "A")
                    return;
                
                var triggerDom = $(this).find('.gis-element-items');
                if (triggerDom.hasClass('d-none')) {
                    $('.gis-element-items').addClass('d-none');
                }
                triggerDom.toggleClass('d-none');
            });
            // process geojson data display or hide based on checkbox status
            $('input[type=checkbox]').on('change', function(){
                var checked = $(this).is(':checked');

                var layerName = $(this).attr('data-target');
                var layerType = $(this).attr('data-toggle');
                var layerColor = $(this).attr('data-color');

                // prepare safe name for additional id tree element display
                var layerIdName = layerName.replace(":", "-_-");
                
                if (!layerName || layerName.length < 3 || !layerType || layerType.length < 3) {
                    return false;
                }
                
                // process "check all" checkbox features
                if (layerType == "checkall") {
                    layerName.split(",").forEach(function(item){
                        $('#' + item).prop('checked', checked).trigger('change');
                    });
                }

                // process display/hide layers from API geoserver
                if (checked) {
                    // if layer is always on the map - do not process action twice
                    if (layerName in enabledLayers && enabledLayers[layerName] === true) {
                        return true;
                    }
                    displayLayerType(layerType, layerName, map, layerColor);
                    enabledLayers[layerName] = true;
                    // display tree button with "more" action
                    $(this).parent().find('label').after(" <a href='javascript:void(0)' id='modaltree-"+layerIdName+"' class='modal-tree-display'>🔎</a>");
                } else {
                    removeLayer(layerName);
                    enabledLayers[layerName] = false;
                    $(this).parent().find("a#modaltree-"+layerIdName).remove();
                }
            });
            // process zoom buttons
            $('#gis-zoom-azov').on('click', function(){
                map.setView([46.1, 36.5], 8);
            });
            $('#gis-zoom-blacksea').on('click', function(){
                map.setView([43.8, 36.2], 8);
            });
            $('#gis-zoom-rostov').on('click', function(){
                map.setView([47.2, 39.7], 9);
            });
            $('#gis-zoom-krasnodar').on('click', function(){
                map.setView([45.0, 38.9], 9);
            });
            
            // change tile layer
            $('input[name=gis-tile]:radio').change(function(){
                map.removeLayer(bg);
                var mid = $(this).attr('id');
                if (mid === 'gis-tile-azniirkh') {
                    bg = L.tileLayer.wms('https://map.azniirkh.ru/geoserver/azniirkh_zones/wms?', {
                        layers: 'base_layer_250_02_egps3857_geotiff',
                        attribution: '&copy; <a href="http://azniirkh.ru">AzNIIRKH</a>'
                    }).addTo(map);
                    map.options.crs = L.CRS.EPSG3857;
                }
                if (mid === 'gis-tile-yandex') {
                    bg = L.tileLayer(
                      'https://sat{s}.maps.yandex.net/tiles?l=sat&v=3.378.0&z={z}&x={x}&y={y}&lang=ru_RU', {
                        subdomains: ['01', '02', '03', '04'],
                        attribution: '<a href="https://yandex.ru" target="_blank">Яндекс</a> | <a href="http://azniirkh.ru">АзНИИРХ</a>',
                        reuseTiles: true,
                        updateWhenIdle: false
                      }
                    ).addTo(map)
                    map.options.crs = L.CRS.EPSG3395;
                }
                if (mid === 'gis-tile-yandex-scheme') {
                    bg = L.tileLayer(
                      'https://vec{s}.maps.yandex.net/tiles?l=map&v=18.06.17-0&z={z}&x={x}&y={y}&lang=ru_RU', {
                        subdomains: ['01', '02', '03', '04'],
                        attribution: '<a href="https://yandex.ru" target="_blank">Яндекс</a> | <a href="http://azniirkh.ru">АзНИИРХ</a>',
                        reuseTiles: true,
                        updateWhenIdle: false
                      }
                    ).addTo(map)
                    map.options.crs = L.CRS.EPSG3395;
                }
                
                var zoomIdx = map.getZoom();
                map.setZoom(zoomIdx+1);
                setTimeout(function(){
                    map.setZoom(zoomIdx);
                }, 800);
            });

            // display modal window on icon click
            $(document).on('click', '.modal-tree-display', function(){
                var treeId = $(this).attr('id');
                var layerName = treeId.replace("-_-", ":").replace("modaltree-", "");
                var modal = $('#modalTreeDisplay');
                modal.find('#display-layer-name-span').text(layerName);

                if (lay == 'undefined' || !(layerName in lay)) {
                    modal.find('.modal-feature').html('<p>Нет информации о данном слое</p>');
                    modal.show();
                    return;
                }

                var modalbody = modal.find('.modal-feature');
                var html = '<div class="table-responsive"><table class="table" id="modal-tree-table">';
                html += '<thead><tr><td>Название</td><td>Действия</td></tr></thead>';
                html += '<tbody>';
                
                var lyr = lay[layerName];
                for (var k in lyr._layers) {
                    var feature = lyr._layers[k];
                    var fulltext = feature._popup.getContent();
                    var div = document.createElement('div');
                    div.innerHTML = fulltext;
                    var text = div.getElementsByTagName('strong')[0].innerText;
                    if (text == 'undefined' || text == '') {
                        text = 'unknown';
                    }

                    var featureId = feature.feature.id;
                    var action = '<a href="javascript:void(0)" class="moveToLeafletLayer" data-group="'+layerName+'" data-id="layer-' + feature._leaflet_id + '">Просмотр</a>';

                    html += '<tr id="tree-row-'+feature._leaflet_id+'"><td class="modal-search-index">' + text + '</td><td>' + action + '</td></tr>';
                    //console.log(feature);
                }

                html += '</tbody>';
                html += '</table></div>';

                modalbody.html(html);
                modal.modal('show');
            });

            // process click event on legend features - zoom to layer and show popup
            $(document).on('click', '.moveToLeafletLayer', function(){
                var oid = $(this).attr('data-id').replace('layer-', '');
                var layerName = $(this).attr('data-group');

                var lyr = lay[layerName];
                var found = false;
                for (var k in lyr._layers) {
                    var item = lyr._layers[k];
                    // found required layer
                    if (item._leaflet_id == oid) {
                        found = true;
                        item.openPopup();
                        map.fitBounds(item.getBounds());
                        $('#modalTreeDisplay').modal('hide');
                    }
                }
            });

            // process modal search
            $('#modal-search-btn').on('click', function(){
                var query = $('#modal-search-field').val();
                if (query == '' || query.length < 3) {
                    alert("Запрос слишком короткий!");
                    return;
                }
                query = query.toLowerCase();

                var tableSelector = $('#modal-tree-table');
                var foundIdx = 0;
                tableSelector.find('td.modal-search-index').each(function(){
                    var row = this.innerText.toLowerCase();
                    // check if row contains search query
                    if (row.indexOf(query) !== -1) {
                        var foundId = $(this).parent().attr('id');
                        $(this).parent().addClass('alert-success');
                        foundIdx++;
                        //$('body').scrollTo('#' + foundId);
                    } else {
                        $(this).parent().removeClass('alert-success');
                    }
                });
                
                $('#modal-found-text').removeClass("d-none");
                $('#modal-found-count').text(foundIdx);
            });
        });
        
        // fix bootstrap custom-checkbox bug - uncheck all boxes on page overload
        $('.custom-control-input').prop('checked', false);
        $('#gis-tile-yandex-scheme').prop('checked', true);

        //map.on('click', function (e) {
        //    alert("Широта: " + e.latlng.lat.toFixed(6) + ", долгота: " + e.latlng.lng.toFixed(6));
        //});
    </script>
</body>
</html>