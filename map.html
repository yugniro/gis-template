<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embedded map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/map.css" rel="stylesheet">
    <link href="vendor/leaflet/leaflet.css" rel="stylesheet">
    <style>
        html,body {
            width: 100%;
            height: 100%;
        }
        section.map {
            display: flex;
            height: 100%;
            width: 100%;
        }
        #azniirkh-map {
            height: 100%;
            flex: 1 50%;
        }
        #azniirkh-legend {
            height: 100%;
            flex: 1;
        }
    </style>
</head>
<body>

<section class="map">
    <div id="azniirkh-map"></div>
    <div id="azniirkh-legend">
        <div class="card">
            <div class="card-header mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="card-body p-0">
                <ul class="nav nav-tabs nav-fill mb-2" id="menuTab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" href="#data" role="tab" id="data-tab" data-toggle="tab" aria-controls="data" aria-selected="true">–°–ª–æ–∏</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#settings" role="tab" id="settings-tab" data-toggle="tab" aria-controls="settings" aria-selected="false">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                  </li>
                </ul>
                <div class="tab-content" id="menuTabContent">
                  <div class="tab-pane fade show active" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="gis-layer-list">
						<!--<div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-waters" data-toggle="multilayer" data-target="azniirkh_zones:water-bodies-all,multipoly;azniirkh_zones:waterways-all,lines">
                                    <label class="custom-control-label" for="gis-waters">–í–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–¥–∞–Ω–Ω—ã–µ OSM)</label>
                                </div>
                            </div>
                        </div>-->
						<div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">–í–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</div>
                            <small class="text-muted d-none d-sm-block">–í–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –∑–æ–Ω–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ê–∑–ù–ò–ò–†–•</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-rostov-waters" data-toggle="multilayer" data-target="azniirkh_zones:water-bodies-rostov,multipoly;azniirkh_zones:waterways-rostov,lines" data-color="#00cee4">
                                    <label class="custom-control-label" for="gis-rostov-waters">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª</label>
                                </div>
                                <!--<hr style="margin: 0;" />
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="show-all-rvu" data-toggle="checkall" data-target="rvu-rostov-areas,rvu-krasnodar-areas,rvu-stavropol-areas">
                                    <label class="custom-control-label" for="show-all-rvu">–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–ª–æ–∏</label>
                                </div>-->
                            </div>
                        </div>
						<div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-oopt" data-toggle="multipoly" data-target="azniirkh_zones:oopt" data-color="#e21776">
                                    <label class="custom-control-label" for="gis-oopt">–û—Å–æ–±–æ –æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –∑–æ–Ω—ã</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="gis-azniirkh-zone" data-toggle="multipoly" data-target="azniirkh_zones:azniirkh_zone" data-color="#e24418">
                                    <label class="custom-control-label" for="gis-azniirkh-zone">–ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ê–∑–ù–ò–ò–†–•</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-group-layer ml-2 pl-3">
                            <div class="gis-element-title">–†—ã–±–æ–≤–æ–¥–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏</div>
                            <small class="text-muted d-none d-sm-block">–ì—Ä–∞–Ω–∏—Ü—ã —Ä—ã–±–æ–≤–æ–¥–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ —Å—É–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–∞</small>
                            <div class="gis-element-items pl-2 d-none">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-rostov-areas" data-toggle="multipoly" data-target="azniirkh_zones:rvu_rostovskaya_oblast" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-rostov-areas">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-krasnodar-areas" data-toggle="multiline" data-target="azniirkh_zones:rvu_krasnodarsky_kray" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-krasnodar-areas">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</label>
                                </div>
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rvu-stavropol-areas" data-toggle="multiline" data-target="azniirkh_zones:rvu_stavropolsky_kray" data-color="#2a68d3">
                                    <label class="custom-control-label" for="rvu-stavropol-areas">–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π</label>
                                </div>
                                <hr style="margin: 0;" />
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="show-all-rvu" data-toggle="checkall" data-target="rvu-rostov-areas,rvu-krasnodar-areas,rvu-stavropol-areas">
                                    <label class="custom-control-label" for="show-all-rvu">–ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–ª–æ–∏</label>
                                </div>
                            </div>
                        </div>
                        <div class="gis-layer ml-2 pl-3">
                            <div class="gis-element">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="rpu-all-zones" data-toggle="multipoly" data-target="azniirkh_zones:rpu" data-color="#e0b90d">
                                    <label class="custom-control-label" for="rpu-all-zones">–†—ã–±–æ–ø—Ä–æ–º—ã—Å–ª–æ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏</label>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>
                  <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                  <div class="gis-settings">
                    <div class="text-head-major">–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±–ª–∞—Å—Ç–∏</div>
                        <div class="ml-2">
                            <span class="badge badge-light" id="gis-zoom-azov">üîé –ê–∑–æ–≤</span>
                            <span class="badge badge-light" id="gis-zoom-blacksea">üîé –ß–ú</span>
                            <span class="badge badge-light" id="gis-zoom-rostov">üîé –†–æ—Å—Ç–æ–≤</span>
                            <span class="badge badge-light" id="gis-zoom-krasnodar">üîé –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</span>
                        </div>
                  </div>
                  <div class="gis-settings">
                    <div class="text-head-major">–ü–æ–¥–ª–æ–∂–∫–∞</div>
                    <div class="ml-2">
                        <div class="custom-control custom-radio custom-control-inline">
                          <input type="radio" id="gis-tile-yandex" name="gis-tile" class="custom-control-input" checked>
                          <label class="custom-control-label" for="gis-tile-yandex">–Ø–Ω–¥–µ–∫—Å</label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline">
                          <input type="radio" id="gis-tile-azniirkh" name="gis-tile" class="custom-control-input">
                          <label class="custom-control-label" for="gis-tile-azniirkh">–ê–∑–ù–ò–ò–†–•</label>
                        </div>
                    </div>
                  </div>
                  <div class="gis-settings">
                    <div class="text-head-major">–ú–µ—Å—Ç–Ω–æ—Å—Ç—å</div>
                    <div class="ml-2">
                        <div class="custom-control custom-checkbox custom-control-inline">
                          <input type="checkbox" id="gis-cities" name="gis-cities" class="custom-control-input" data-toggle="point" data-target="azniirkh_zones:south_russia_placekeys">
                          <label class="custom-control-label" for="gis-cities">–ì–æ—Ä–æ–¥–∞</label>
                        </div>
                        <div class="custom-control custom-checkbox custom-control-inline">
                          <input type="checkbox" id="gis-borders" name="gis-borders" class="custom-control-input">
                          <label class="custom-control-label" for="gis-borders">–û–∫—Ä—É–≥–∞</label>
                        </div>
                    </div>
                  </div>
                  </div>
                </div>
            </div>
        </div>
    </div>
</section>

    <script src="vendor/jquery/jquery-3.3.1.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/leaflet/leaflet.js"></script>
    <script src='vendor/turf/turf.min.js'></script>
    <script src="js/gis.js"></script>

    <script>
        var enabledLayers = {};

        // define map object with center
        var map = L.map('azniirkh-map').setView([46, 36], 7);
        
        var bg = L.tileLayer(
          'https://sat{s}.maps.yandex.net/tiles?l=sat&v=3.378.0&z={z}&x={x}&y={y}&lang=ru_RU', {
            subdomains: ['01', '02', '03', '04'],
            attribution: '<a href="https://yandex.ru" target="_blank">–Ø–Ω–¥–µ–∫—Å</a> | <a href="http://azniirkh.ru">–ê–∑–ù–ò–ò–†–•</a>',
            reuseTiles: true,
            updateWhenIdle: false
          }
        ).addTo(map);
        // change map projection. Yandex: L.CRS.EPSG3395
        map.options.crs = L.CRS.EPSG3395;

        // execute after-load features with jquery
        $(function(){
            // visual display hidden elements
            $('.gis-group-layer').on('click', function(e) {
                var clickedTargetName = $(e.target).prop('tagName');
                if(clickedTargetName == "INPUT" || clickedTargetName === "LABEL")
                    return;
                
                var triggerDom = $(this).find('.gis-element-items');
                if (triggerDom.hasClass('d-none')) {
                    $('.gis-element-items').addClass('d-none');
                }
                triggerDom.toggleClass('d-none');
            });
            // process geojson data display or hide based on checkbox status
            $('input[type=checkbox]').on('change', function(){
                var checked = $(this).is(':checked');

                var layerName = $(this).attr('data-target');
                var layerType = $(this).attr('data-toggle');
                var layerColor = $(this).attr('data-color');
                
                if (!layerName || layerName.length < 3 || !layerType || layerType.length < 3) {
                    return false;
                }
                
                // process "check all" checkbox features
                if (layerType == "checkall") {
                    layerName.split(",").forEach(function(item){
                        $('#' + item).prop('checked', checked).trigger('change');
                    });
                }

                // process display/hide layers from API geoserver
                if (checked) {
                    if (layerName in enabledLayers && enabledLayers[layerName] === true) {
                        return true; // do not load data if always used
                    }
                    displayLayerType(layerType, layerName, map, layerColor);
                    enabledLayers[layerName] = true;
                } else {
                    removeLayer(layerName);
                    enabledLayers[layerName] = false;
                }
            });
            // process zoom buttons
            $('#gis-zoom-azov').on('click', function(){
                map.setView([46.1, 36.5], 8);
            });
            $('#gis-zoom-blacksea').on('click', function(){
                map.setView([43.8, 36.2], 8);
            });
            $('#gis-zoom-rostov').on('click', function(){
                map.setView([47.2, 39.7], 9);
            });
            $('#gis-zoom-krasnodar').on('click', function(){
                map.setView([45.0, 38.9], 9);
            });
            
            // change tile layer
            $('input[name=gis-tile]:radio').change(function(){
                map.removeLayer(bg);
                var mid = $(this).attr('id');
                if (mid === 'gis-tile-azniirkh') {
                    bg = L.tileLayer.wms('https://map.azniirkh.ru/geoserver/azniirkh_zones/wms?', {
                        layers: 'base_layer_250_02_egps3857_geotiff',
                        attribution: '&copy; <a href="http://azniirkh.ru">AzNIIRKH</a>'
                    }).addTo(map);
                    map.options.crs = L.CRS.EPSG3857;
                }
                if (mid === 'gis-tile-yandex') {
                    bg = L.tileLayer(
                      'https://sat{s}.maps.yandex.net/tiles?l=sat&v=3.378.0&z={z}&x={x}&y={y}&lang=ru_RU', {
                        subdomains: ['01', '02', '03', '04'],
                        attribution: '<a href="https://yandex.ru" target="_blank">–Ø–Ω–¥–µ–∫—Å</a> | <a href="http://azniirkh.ru">–ê–∑–ù–ò–ò–†–•</a>',
                        reuseTiles: true,
                        updateWhenIdle: false
                      }
                    ).addTo(map)
                    map.options.crs = L.CRS.EPSG3395;
                }
            });
        });
        
        // fix bootstrap custom-checkbox bug - uncheck all boxes on page overload
        $('.custom-control-input').prop('checked', false);
        $('#gis-tile-yandex').prop('checked', true);

        //map.on('click', function (e) {
        //    alert("Lat: " + e.latlng.lat + ", lon: " + e.latlng.lng);
        //});
    </script>
</body>
</html>